<!DOCTYPE html>
<html>

<head>
    <title>handsontable demo</title>
    <link rel="stylesheet" media="screen" href="dist/handsontable.full.min.css">
    <script src="dist/handsontable.full.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="dist/chart.min.js"></script>
     <script type="text/javascript" charset="utf-8" src="dist/dot.min.js"></script>
</head>

<body>
    <div id="container"></div>
    <div id="chartTypeList">
        <button data-prop="bar" onclick="draw('bar')">柱状图</button>
        <button data-prop="line" onclick="draw('line')">线状图</button>
    </div>
    <div id="actionTypeList">
        <button data-prop="bar" onclick="update()">更新数据</button>
        <button data-prop="bar" onclick="exportChart()">导出图表</button>
    </div>
    <div id="event_logger"></div>
    <canvas id="myChart" width="400" height="400"></canvas>
    <script type="text/javascript">
    var $$ = function(el) {
        return document.getElementById(el);
    }

    var global_hstable;
    var global_type, global_labels, global_datasets;

    var T = function() {
        this.initConfig();
        this.bindData();

        this.bindEvent();
    }

    T.prototype.initConfig = function() {
        //todo binding data
        var _this = this;
        this.data = data = [
            ['', 'Tesla', 'Mazda', 'Mercedes', 'Mini', 'Mitsubishi', 'AA', 'BB', 'CC', 'DD', 'EE'],
            ['2017', 0, 2941, 4303, 354, 5814, 2, 2422, 5399, 776, 4151],
            ['2018', 3, 2905, 2867, 412, 5284, 0, 2941, 4303, 354, 5814],
            ['2019', 4, 2517, 4822, 552, 6127, 3, 2905, 2867, 412, 5284],
            ['2020', 2, 2422, 5399, 776, 4151, 4, 2517, 4822, 552, 6127]
        ];

        this.container = $$("container");
        this.event_logger = $$("event_logger");

        this.config = {
            data: data,
            minRows: 5,
            minCols: 6,
            minSpareRows: 1,
            autoWrapRow: true,
            colHeaders: true,
            contextMenu: true
        }

        this.preHookList = ["afterSelection", "afterChange"];

        this.preHookList.forEach(function(hook) {
            _this.config[hook] = function() {
                log_events(hook, arguments);
            }
        });
    }

    T.prototype.bindData = function() {
        var _this = this;
        global_hstable = this.hstable = new Handsontable(_this.container, _this.config);
    }

    T.prototype.bindEvent = function() {

    }

    T.prototype.generateData = function(coordinate) {
        //gen labels
        var D = this.data;
        var totalLabels = this.data[0];
        var sa = coordinate;
        var labels = [];

        for (var i = sa["sx"]; i <= sa["ex"]; i++) {
            labels.push(totalLabels[i]);
        }

        //gen data
        var datasets = [];
        var d = [];
        if (sa["sx"] == 0) { sa["sx"] = 1 };
        if (sa["sy"] == 0) { sa["sy"] = 1 };

        for (var i = sa["sx"]; i <= sa["ex"]; i++) {
            var data = [];
            for (var j = sa["sy"]; j <= sa["ey"]; j++) {
                data.push(D[i][j]);
            }
            datasets.push({
                label: D[i][0],
                data: data,
                borderWidth: 1,
                fill: false
            });

            d.push({
                label: D[i][0],
                data: data,
                borderWidth: 1,
                fill: false
            })

            // console.log("==data==",)
        }

        console.log("==labels==", labels);
        console.log("==datasets==", datasets);
         console.log("==d==", d);

        global_labels = labels;
        global_datasets = d;

        return {
            "labels": labels,
            "datasets": datasets
        }
    }

    var myT = new T();


    var start = (new Date()).getTime();
    var i = 0;
    var timer;
    var event_logger = document.getElementById("event_logger");

    var selectionArea, changedArea;


    function log_events(event, data) {
        switch (event) {
            case "afterSelection":
                selectionArea = {
                    sx: parseInt(data[0]), //startX
                    sy: parseInt(data[1]), //startY
                    ex: parseInt(data[2]), //endX
                    ey: parseInt(data[3]) //endY
                };
                console.log("==selectionArea==", selectionArea)
                break;
            case "afterChange":
                var d = data[0];
                if (d) {
                    console.log("==data[0]==", data[0]);
                    changedArea = {
                        "px": d[0][0], //positionX
                        "py": d[0][1], //positionY
                        "ov": d[0][2], //old_value
                        "nv": d[0][3] //new_value
                    }
                }
                break;
            default:
                break;
        }
    }

    function update() {
        let headers = new Headers( {
            "Content-Type": "application/json"
            });
        // let opt = Object.assign({}, defaultOptions, options); //将默认的参数和传过来的合并在一起
  
        let sentData = {
            method: "POST",
            mode: 'cors',
            headers: headers,
            body: JSON.stringify(changedArea)
        };
        var promise = new Promise((reslove, reject) => {
            fetch("http://127.0.0.1:3000/update", sentData)
                .then(response => response.json())
                .then(responseText => {
                    let resp = typeof responseText === 'string' ? JSON.parse(responseText) : responseText;
                    console.log(resp);
                    reslove(resp); //这个resp会被外部接收
                }).catch(err => {
                    console.log(err);
                    reject(err);
                });
        }).catch(err => {
            console.log('出错了');
        });

        promise.then(function(value){
            global_hstable.setDataAtCell(value["px"], value["py"], parseInt(value["nv"]));
            console.log(value);
        }).catch(function(error){
            console.error(error);
        });
      }

    function draw(type) {
      global_type = type;
        var ctx = document.getElementById("myChart").getContext('2d');
        var result = myT.generateData(selectionArea);

        var myChart = new Chart(ctx, {
            type: type,
            data: {
                labels: result["labels"],
                datasets: result["datasets"]
            },
            options: {

            }
        });
    }

    function wrapper(str){
      return ["\"", str.replace(/\"/,"\""),"\""].join("")
    }

    function exportChart(){
      let header = new Headers({
            // 'Access-Control-Allow-Origin': '*',
            'Content-Type': 'application/json'
        });
        // let opt = Object.assign({}, defaultOptions, options); //将默认的参数和传过来的合并在一起
        var exportData = {
                type: global_type,
                labels: global_labels,
                datasets: global_datasets
            };
        

        let sentData = {
            method: "POST",
            mode: 'cors',
            headers: header,
            body: JSON.stringify(exportData)
        };

        console.log("==sentData==", sentData);

      var promise = new Promise((reslove, reject) => {
            fetch("http://127.0.0.1:3000/export", sentData)
                // .then(response => response.json())
                .then(responseText => {
                    // let resp = typeof responseText === 'string' ? JSON.parse(responseText) : responseText;
                    let resp = responseText;
                    console.log(resp);
                    reslove(resp); //这个resp会被外部接收
                }).catch(err => {
                    console.log(err);
                    reject(err);
                });
        }).catch(err => {
            console.log('出错了');
        });

        promise.then(function(value){
             window.open("http://127.0.0.1:3000/new.html");
            console.log(value);
        }).catch(function(error){
            console.error(error);
        });
    }


  
    </script>
    <script>
    </script>
</body>

</html>